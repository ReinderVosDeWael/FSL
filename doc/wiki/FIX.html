<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>FIX</title>
<link rel="stylesheet" type="text/css" media="all" charset="utf-8" href="fsl/css/common.css">
<link rel="stylesheet" type="text/css" media="screen" charset="utf-8" href="fsl/css/screen.css">
<link rel="stylesheet" type="text/css" media="print" charset="utf-8" href="fsl/css/print.css">
<style type="text/css">
ul.pagetitle{
  display: inline;
  margin: 0;
  padding: 0;
  font-size: 1.5em;
}
li.pagetitle{
  display: inline;
  margin: 0;
}
td.noborder {
  border: 0;
}
</style>
</head>
<body>
<table>
<tr>
<td class="noborder">
<img src="logo.png">
</td>
<td class="noborder">
<ul class="pagetitle">
<li class="pagetitle"><a class="backlink">FIX</a>
</ul>
<br><br>
[<a href="FSL.html">FSL</a>]&nbsp;[<a href="TitleIndex.html">TitleIndex</a>]&nbsp;[<a href="WordIndex.html">WordIndex</a>]&nbsp;
</td>
</tr>
</table>
<hr>
<div id="page">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><p class="line867"><img align="right" alt="artefact.png" class="attachment" src="attachments/FIX/artefact.png" title="artefact.png" width="400" /> <span class="anchor" id="line-2"></span> <span class="anchor" id="line-3"></span><hr /><p class="line874"> <span class="anchor" id="line-4"></span>
<h1 id="Overview_-_FMRIB.27s_ICA-based_Xnoiseifier_-_FIX_v1.06_beta">Overview - FMRIB's ICA-based Xnoiseifier - FIX v1.06 beta</h1>
<span class="anchor" id="line-5"></span><span class="anchor" id="line-6"></span><p class="line862">FIX attempts to auto-classify ICA components into "good" vs "bad" components, so that the bad components can be removed from the 4D FMRI data. FIX is intended to be run on single-session <a href="./MELODIC.html">MELODIC</a> ICA output.  See <a class="http" href="http://users.fmrib.ox.ac.uk/~steve/fix_eg.html">example raw data movies</a> showing the (potentially huge) effect of FIX cleanup. This beta-version of FIX is a set of R, MATLAB and shell scripts and hence requires you to have various other software than just FSL - and for now is not bundled as part of FSL. If you use FIX, please cite these papers: <span class="anchor" id="line-7"></span><span class="anchor" id="line-8"></span><p class="line867"><span class="anchor" id="line-9"></span><span class="anchor" id="line-10"></span><span class="anchor" id="line-11"></span><span class="anchor" id="line-12"></span><div class="references"><span class="anchor" id="line-1-1"></span><p class="line867"><a class="http" href="http://www.ncbi.nlm.nih.gov/pubmed/24389422">1.</a> G. Salimi-Khorshidi, G. Douaud, C.F. Beckmann, M.F. Glasser, L. Griffanti S.M. Smith. Automatic denoising of functional MRI data: Combining independent component analysis and hierarchical fusion of classifiers. NeuroImage, 90:449-68, 2014 <span class="anchor" id="line-2-1"></span><span class="anchor" id="line-3-1"></span><p class="line862">2. L. Griffanti, G. Salimi-Khorshidi, C.F. Beckmann, E.J. Auerbach, G. Douaud, C.E. Sexton, E. Zsoldos, K. Ebmeier, N. Filippini, C.E. Mackay, S. Moeller, J.G. Xu, E. Yacoub, G. Baselli, K. Ugurbil, K.L. Miller, and S.M. Smith. ICA-based artefact removal and accelerated fMRI acquisition for improved resting state network imaging. NeuroImage, in press, 2014 </div><span class="anchor" id="line-13"></span><span class="anchor" id="line-14"></span><p class="line874">This latest version (1.06) can now be run without Matlab, using either the supplied precompiled-matlab binaries, or with Octave.  The other change from v1.05 is a change in the top-level meta-classifier, which gives a tiny average improvement in classification accuracy. No need to rerun feature generation from v1.05 for use in v1.06, but the old training files cannot be used with v1.06 (and any custom training files will need regenerating). <span class="anchor" id="line-15"></span><span class="anchor" id="line-16"></span><p class="line874">For FIX to work well, it is very important that it is run using good "training data".  While a few example training files are supplied with FIX, for major studies we would strongly recommend training FIX on your study data (see below for more details). <span class="anchor" id="line-17"></span><span class="anchor" id="line-18"></span><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-19"></span>
<h1 id="Installing_FIX">Installing FIX</h1>
<span class="anchor" id="line-20"></span><span class="anchor" id="line-21"></span><p class="line874">Requirements: <span class="anchor" id="line-22"></span><ul><li><p class="line891"><a class="http" href="http://www.fmrib.ox.ac.uk/fsl">FSL</a> <span class="anchor" id="line-23"></span></li><li>MATLAB (though see above...), with official toolboxes: <span class="anchor" id="line-24"></span><ul><li>Statistics <span class="anchor" id="line-25"></span></li><li>Signal Processing <span class="anchor" id="line-26"></span></li></ul></li><li><p class="line891"><a class="http" href="http://www.r-project.org/">R</a> free statistics software <span class="anchor" id="line-27"></span><span class="anchor" id="line-28"></span></li></ul><p class="line874">Setup FIX: <span class="anchor" id="line-29"></span><ul><li><p class="line862">Unpack <a class="http" href="http://www.fmrib.ox.ac.uk/~steve/ftp/fix.tar.gz">FIX</a> with <tt>tar&nbsp;xvfz&nbsp;fix.tar.gz</tt> (or <tt>tar&nbsp;xvf&nbsp;fix.tar</tt> if your browser has already uncompressed the file). <span class="anchor" id="line-30"></span></li><li><p class="line862">See the <tt>README</tt> file for further setup instructions <span class="anchor" id="line-31"></span><span class="anchor" id="line-32"></span></li></ul><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-33"></span><span class="anchor" id="line-34"></span><p class="line867">
<h1 id="Running_FIX">Running FIX</h1>
<span class="anchor" id="line-35"></span><span class="anchor" id="line-36"></span><p class="line874">To run: use the script "fix" in the FIX directory, e.g.: <span class="anchor" id="line-37"></span><span class="anchor" id="line-38"></span><p class="line867"><span class="anchor" id="line-39"></span><span class="anchor" id="line-40"></span><pre><span class="anchor" id="line-1"></span>/usr/local/fix/fix  YOURFEAT.feat  /usr/local/fix/training_files/Standard.RData  20</pre><span class="anchor" id="line-41"></span><span class="anchor" id="line-42"></span><p class="line874">You need to feed in a full "first-level" (single-session) output <span class="anchor" id="line-43"></span>directory created by the MELODIC or FEAT GUIs, with full registration <span class="anchor" id="line-44"></span>run, including using a structural. If using FEAT, you need to have had <span class="anchor" id="line-45"></span>ICA turned on in the <tt>Prestats</tt>.  For the ICA you should in general use MELODIC's <span class="anchor" id="line-46"></span>automatic dimensionality estimation. <span class="anchor" id="line-47"></span><span class="anchor" id="line-48"></span><p class="line862">The <tt>20</tt> refers to the thresholding of good vs bad components; sensible values are generally in the range of 5-20. However, if it is very important to you that almost no good components are removed, and hence you would prefer to leave in the data a larger number of bad components, then use a low threshold (e.g., in the range 1-5). <span class="anchor" id="line-49"></span><span class="anchor" id="line-50"></span><p class="line874">It is strongly recommended that you look at the ICA components yourself to <span class="anchor" id="line-51"></span>check at least a few of your subjects' classifications - look in the <span class="anchor" id="line-52"></span>file called something like fix4melview_Standard_thr20.txt - the final <span class="anchor" id="line-53"></span>line lists the components that are considered as noise to be removed <span class="anchor" id="line-54"></span>(with counting starting at 1 not 0). <span class="anchor" id="line-55"></span><span class="anchor" id="line-56"></span><p class="line862">When running fix as shown above, you will end up with a cleaned version of the 4D preprocessed FMRI data: <tt>filtered_func_data_clean.nii.gz</tt>. <span class="anchor" id="line-57"></span><span class="anchor" id="line-58"></span><p class="line874">If you have a compute cluster you can send the whole command to the cluster <span class="anchor" id="line-59"></span>by preceding it with something like <tt>fsl_sub&nbsp;-q&nbsp;long.q&nbsp;...&nbsp;</tt>  (Although, if <span class="anchor" id="line-60"></span>you are using fix to train the classifier and run leave-one-out <span class="anchor" id="line-61"></span>testing, we recommend that you run fix locally, if your local computer is able to <span class="anchor" id="line-62"></span>submit jobs to your cluster, as it will do this for you, parallelising <span class="anchor" id="line-63"></span>the LOO, and greatly speeding it up.) <span class="anchor" id="line-64"></span><span class="anchor" id="line-65"></span><p class="line867">
<h2 id="Training_data">Training data</h2>
<span class="anchor" id="line-66"></span><span class="anchor" id="line-67"></span><p class="line862">FIX needs to be trained from multiple datasets that have already had the ICA components classified into "good" and "bad" by hand. We have so far hand-trained a few different types of data, and the training file from each of these is supplied with FIX. If you want to train FIX yourself (which in general is recommended), to better optimise it for the kind of data you have, you will need to do this hand classification yourself (at <em>least</em> 10 subjects). Alternatively, you can use one of the training <tt>*.RData</tt> files supplied with FIX. <span class="anchor" id="line-68"></span><span class="anchor" id="line-69"></span><p class="line874">There are currently several training-dataset-files supplied: <span class="anchor" id="line-70"></span><ul><li><p class="line891"><tt>Standard.RData</tt> - for use on more "standard" FMRI datasets / analyses; e.g., TR=3s, Resolution=3.5x3.5x3.5mm, Session=6mins, default FEAT preprocessing (including default spatial smoothing). <span class="anchor" id="line-71"></span></li><li><p class="line891"><tt>HCP_hp2000.RData</tt> for use on "minimally-preprocessed" HCP-like datasets, e.g., TR=0.7s, Resolution=2x2x2mm, Session=15mins, no spatial smoothing, minimal (2000s FWHM) highpass temporal filtering. <span class="anchor" id="line-72"></span></li><li><p class="line891"><tt>WhII_MB6.RData</tt> derived from the Whitehall imaging study, using multiband x6 EPI acceleration: TR=1.3s, Resolution=2x2x2mm, Session=10mins, no spatial smoothing, 100s FWHM highpass temporal filtering. <span class="anchor" id="line-73"></span></li><li><p class="line891"><tt>WhII_Standard.RData</tt> derived from more traditional early parallel scanning in the Whitehall imaging study, using no EPI acceleration: TR=3s, Resolution=3x3x3mm, Session=10mins, no spatial smoothing, 100s FWHM highpass temporal filtering. <span class="anchor" id="line-74"></span><span class="anchor" id="line-75"></span></li></ul><p class="line862">To do your own training, for each FEAT/MELODIC output directory, you will need to create a <tt>hand_labels_noise.txt</tt> file in the output directory. This text file should contain a single line (or, at least, should have as its final line), a list of the <strong>bad</strong> components only, with the format (for example): <tt>[1,&nbsp;4,&nbsp;99,&nbsp;...&nbsp;140]</tt> - note that the square brackets, and use of commas, is required. Counting starts at 1, not 0. <span class="anchor" id="line-76"></span><span class="anchor" id="line-77"></span><p class="line862">Once you have created all of the hand label files, you can then train the classifier (creating the training file <tt>&lt;Training&gt;.RData</tt>) using the <tt>-t</tt> option: <span class="anchor" id="line-78"></span><span class="anchor" id="line-79"></span><p class="line867"><span class="anchor" id="line-80"></span><span class="anchor" id="line-81"></span><pre><span class="anchor" id="line-1-1"></span>fix -t &lt;Training&gt; [-l]  &lt;Melodic1.ica&gt; &lt;Melodic2.ica&gt; ...</pre><span class="anchor" id="line-82"></span><span class="anchor" id="line-83"></span><p class="line862">If you include the <tt>-l</tt> option after the training output filename, a full leave-one-out test will be run; the results file that gets created at the end has a set of numbers at the end of it that tell you the true-positive-rate (proportion of "good" components correctly labelled) and the false-positive-rate (proportion of "bad" components correctly labelled) for a wide range of thresholds (see higher up in the output file for the list of thresholds tested). <span class="anchor" id="line-84"></span><span class="anchor" id="line-85"></span><p class="line867">
<h2 id="Using_new_training_data">Using new training data</h2>
<span class="anchor" id="line-86"></span><span class="anchor" id="line-87"></span><p class="line874">You can now use your new training file to classify components in new datasets... <span class="anchor" id="line-88"></span><span class="anchor" id="line-89"></span><p class="line867"><span class="anchor" id="line-90"></span><span class="anchor" id="line-91"></span><span class="anchor" id="line-92"></span><pre><span class="anchor" id="line-1-2"></span>fix -c &lt;Melodic-output.ica&gt; &lt;Training.RData&gt; &lt;thresh&gt;       
<span class="anchor" id="line-2"></span>  classify ICA components (&lt;thresh&gt; is in the range 0-100, typically 20)</pre><span class="anchor" id="line-93"></span><span class="anchor" id="line-94"></span><p class="line874">...and then run the cleanup on the new data... <span class="anchor" id="line-95"></span><span class="anchor" id="line-96"></span><p class="line867"><span class="anchor" id="line-97"></span><span class="anchor" id="line-98"></span><span class="anchor" id="line-99"></span><span class="anchor" id="line-100"></span><pre><span class="anchor" id="line-1-3"></span>fix -a &lt;Melodic-output.ica/fix4melview_TRAIN_thr.txt&gt; [-m]
<span class="anchor" id="line-2-1"></span>  apply cleanup using artefacts listed in the txt file to data inside the enclosing Melodic directory,
<span class="anchor" id="line-3"></span>  and optionally remove  motion confounds with -m)</pre><span class="anchor" id="line-101"></span><span class="anchor" id="line-102"></span><span class="anchor" id="line-103"></span><p class="line867">
<h2 id="Input_files_required_-_in_more_detail">Input files required - in more detail</h2>
<span class="anchor" id="line-104"></span><span class="anchor" id="line-105"></span><p class="line874">If you haven't done the full GUI-based MELODIC/FEAT analysis, you will need, in one directory: <span class="anchor" id="line-106"></span><span class="anchor" id="line-107"></span><span class="anchor" id="line-108"></span><span class="anchor" id="line-109"></span><span class="anchor" id="line-110"></span><span class="anchor" id="line-111"></span><span class="anchor" id="line-112"></span><span class="anchor" id="line-113"></span><span class="anchor" id="line-114"></span><span class="anchor" id="line-115"></span><span class="anchor" id="line-116"></span><span class="anchor" id="line-117"></span><pre><span class="anchor" id="line-1-4"></span>  filtered_func_data.nii.gz          preprocessed 4D data
<span class="anchor" id="line-2-2"></span>  filtered_func_data.ica             melodic (command-line program) full output directory
<span class="anchor" id="line-3-1"></span>  mc/prefiltered_func_data_mcf.par   motion parameters created by mcflirt (in mc subdirectory)
<span class="anchor" id="line-4"></span>  mask.nii.gz                        valid mask relating to the 4D data
<span class="anchor" id="line-5"></span>  mean_func.nii.gz                   temporal mean of 4D data
<span class="anchor" id="line-6"></span>  reg/example_func.nii.gz            example image from 4D data
<span class="anchor" id="line-7"></span>  reg/highres.nii.gz                 brain-extracted structural
<span class="anchor" id="line-8"></span>  reg/highres2example_func.mat       FLIRT transform from structural to functional space
<span class="anchor" id="line-9"></span>  design.fsf                         FEAT/MELODIC setup file; if present, this controls the
<span class="anchor" id="line-10"></span>                                       default temporal filtering of motion parameters</pre><span class="anchor" id="line-118"></span><span class="anchor" id="line-119"></span><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-120"></span><a href="./CategoryOther.html">CategoryOther</a> <a class="nonexistent" href="./CategoryFIX.html">CategoryFIX</a> <span class="anchor" id="line-121"></span><span class="anchor" id="bottom"></span></div>
</div>
<hr>
2014-07-08 15:33
</body>
</html>
